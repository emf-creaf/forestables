<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="forestables">
<title>Selecting plots • forestables</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Selecting plots">
<meta property="og:description" content="forestables">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">forestables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/documentacion.html">UNKNOWN TITLE</a>
    <a class="dropdown-item" href="../articles/inventory_data_tibble.html">Inventory data output</a>
    <a class="dropdown-item" href="../articles/selecting_plots.html">Selecting plots</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Selecting plots</h1>
            
      
      
      <div class="d-none name"><code>selecting_plots.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>This vignette explains how to retrieve information about available
inventory plots and using it to select them based to use in modelling or
analyses.</p>
<p>Workflows with all three inventories (FFI, FIA and IFN) are shown
below</p>
</div>
<div class="section level2">
<h2 id="ffi-workflow">FFI workflow<a class="anchor" aria-label="anchor" href="#ffi-workflow"></a>
</h2>
<p>For the French forest inventory (FFI), we are gonna select all
mediterranean plots sampled in 2012. First step is to select de
departments the plots we want are in.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose the departments, those in the mediterranean area</span></span>
<span><span class="va">mediterranean_deps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"04"</span>, <span class="st">"06"</span>, <span class="st">"11"</span>, <span class="st">"13"</span>, <span class="st">"30"</span>,</span>
<span>  <span class="st">"34"</span>, <span class="st">"66"</span>, <span class="st">"83"</span>, <span class="st">"84"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can use the department codes to obtain some basic metadata
(plot codes, coordinates and campaign year) with
<code><a href="../reference/show_plots_from.html">show_plots_from()</a></code>. For this we need the inventory we want
plots from, the folder containing the downloaded inventory files and a
vector with the department codes (as created above):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get the plots for those departments</span></span>
<span><span class="va">mediterranean_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/show_plots_from.html">show_plots_from</a></span><span class="op">(</span></span>
<span>  inventory <span class="op">=</span> <span class="st">"FFI"</span>,</span>
<span>  folder <span class="op">=</span> <span class="va">ffi_folder</span>,</span>
<span>  departments <span class="op">=</span> <span class="va">mediterranean_deps</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mediterranean_plots</span></span></code></pre></div>
<p>These are all the plots present in those departments for all years,
but we want 2012 plots, so we filter the results by campaign year:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mediterranean_plots_2012</span> <span class="op">&lt;-</span> <span class="va">mediterranean_plots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">CAMPAGNE</span> <span class="op">==</span> <span class="fl">2012</span><span class="op">)</span></span>
<span><span class="va">mediterranean_plots_2012</span></span></code></pre></div>
<p>Also, we need a the polygons for the departments for plotting results
later. To obtain them, we are gonna use the <a href=""><code>rnaturalearth</code></a> R package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># france map for plotting</span></span>
<span><span class="va">south_france_map</span> <span class="op">&lt;-</span> <span class="fu">ne_states</span><span class="op">(</span>geounit <span class="op">=</span> <span class="st">"france"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>dep_code <span class="op">=</span> <span class="st">"iso_3166_2"</span>, dep_name <span class="op">=</span> <span class="st">"gn_name"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dep_code <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">dep_code</span>, <span class="st">"FR-"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dep_code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">mediterranean_deps</span><span class="op">)</span></span>
<span><span class="va">south_france_map</span></span></code></pre></div>
<p>Now we can visualize the plots selected:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">south_france_map</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">DEP</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span>, data <span class="op">=</span> <span class="va">mediterranean_plots_2012</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">9</span>, palette <span class="op">=</span> <span class="st">"Zissou 1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Seems like we have the plots we need, so we are going to create a
<em>filter list</em> to use it to retrieve those plots data from the
inventory files:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ffi_filter_list</span> <span class="op">&lt;-</span> <span class="va">mediterranean_plots_2012</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_filter_list.html">create_filter_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we can do all in one pipe:</span></span>
<span><span class="co"># ffi_filter_list &lt;-</span></span>
<span><span class="co">#   show_plots_from("FFI", folder = ffi_folder, departments = mediterranean_deps) |&gt;</span></span>
<span><span class="co">#   filter(CAMPAGNE == 2012) |&gt;</span></span>
<span><span class="co">#   create_filter_list()</span></span></code></pre></div>
<p>And we are ready for retrieving the data from the plots with
<code><a href="../reference/ffi_to_tibble.html">ffi_to_tibble()</a></code>. For that we need the department codes, the
year, the filter list we obtained before and the path to the folder
containing the inventory files.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## We can parallelize the process with the future package.</span></span>
<span><span class="co">## In this case we use 4 parallel processes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the data for the selected plots</span></span>
<span><span class="va">ffi_data_2012</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffi_to_tibble.html">ffi_to_tibble</a></span><span class="op">(</span></span>
<span>  departments <span class="op">=</span> <span class="va">mediterranean_deps</span>,</span>
<span>  years <span class="op">=</span> <span class="fl">2012</span>,</span>
<span>  filter_list <span class="op">=</span> <span class="va">ffi_filter_list</span>,</span>
<span>  folder <span class="op">=</span> <span class="va">ffi_folder</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ffi_data_2012</span></span></code></pre></div>
<p>Now we can explore the data, for example the most abundant species
and their mean diameter for each plot they are in:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ffi_data_2012</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># clean plots without tree data</span></span>
<span>  <span class="fu"><a href="../reference/clean_empty.html">clean_empty</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># convert inventory table to sf/spatial object</span></span>
<span>  <span class="fu"><a href="../reference/inventory_as_sf.html">inventory_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># unnest the tree data</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># calculate dbh by species in each plot</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id_unique_code</span>, <span class="va">sp_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>dbh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dbh</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, dep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dep</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.nan</a></span><span class="op">(</span><span class="va">dbh</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter species with 25 or less entries (plots)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sp_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">15</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># let's plot</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">south_france_map</span>, alpha <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span>, color <span class="op">=</span> <span class="va">dbh</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_gradientn</span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">360</span>, <span class="st">"PinkYl"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">sp_name</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fia-workflow">FIA workflow<a class="anchor" aria-label="anchor" href="#fia-workflow"></a>
</h2>
<p>For the USA forest inventory (FIA) we are going to explore the west
coast inventory plot for 2012. The steps are very similar to the FFI
example. First we need the state codes, retrieve the plots metadata for
those states and filter for the desired year, 2012::</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose the provinces, those in the Cantabric area</span></span>
<span><span class="va">west_coast_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WA"</span>, <span class="st">"CA"</span>, <span class="st">"OR"</span><span class="op">)</span></span>
<span><span class="co"># get the plots for those departments</span></span>
<span><span class="va">west_coast_plots_2012</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/show_plots_from.html">show_plots_from</a></span><span class="op">(</span></span>
<span>  inventory <span class="op">=</span> <span class="st">"FIA"</span>,</span>
<span>  folder <span class="op">=</span> <span class="va">fia_folder</span>,</span>
<span>  states <span class="op">=</span> <span class="va">west_coast_states</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">INVYR</span> <span class="op">==</span> <span class="fl">2012</span><span class="op">)</span></span>
<span><span class="va">west_coast_plots_2012</span></span></code></pre></div>
<p>Also, if we obtain the states polygons with the
<code>rnaturalearth</code> library, we can visualize the plots:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># USA map for plotting</span></span>
<span><span class="va">west_coast_map</span> <span class="op">&lt;-</span> <span class="fu">ne_states</span><span class="op">(</span>geounit <span class="op">=</span> <span class="st">"United States of America"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>state_code <span class="op">=</span> <span class="st">"iso_3166_2"</span>, state_name <span class="op">=</span> <span class="st">"gn_name"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state_code <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">state_code</span>, <span class="st">"US-"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">state_code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">west_coast_states</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">west_coast_map</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">STATEAB</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">west_coast_plots_2012</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">3</span>, palette <span class="op">=</span> <span class="st">"Zissou 1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now that we have the inventory plots selected, we can obtain the
<em>filter list</em> to retrieve the data only from those plots:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fia_filter_list</span> <span class="op">&lt;-</span> <span class="va">west_coast_plots_2012</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_filter_list.html">create_filter_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we can do all in one pipe:</span></span>
<span><span class="co"># fia_filter_list &lt;-</span></span>
<span><span class="co">#   show_plots_from("FIA", folder = fia_folder, states = west_coast_states) |&gt;</span></span>
<span><span class="co">#   filter(INVYR == 2012) |&gt;</span></span>
<span><span class="co">#   create_filter_list()</span></span></code></pre></div>
<p>And now we have everything we need for retrieving the data with
<code><a href="../reference/fia_to_tibble.html">fia_to_tibble()</a></code>. For that we need the state codes, the
year, the filter list we obtained before and the path to the folder
containing the inventory files.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## We can parallelize the process with the future package.</span></span>
<span><span class="co">## In this case we use 4 parallel processes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the data</span></span>
<span><span class="va">fia_data_2012</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fia_to_tibble.html">fia_to_tibble</a></span><span class="op">(</span></span>
<span>  states <span class="op">=</span> <span class="va">west_coast_states</span>,</span>
<span>  years <span class="op">=</span> <span class="fl">2012</span>,</span>
<span>  filter_list <span class="op">=</span> <span class="va">fia_filter_list</span>,</span>
<span>  folder <span class="op">=</span> <span class="va">fia_folder</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As we did with the French inventory, we can now explore the data, for
example, the most abundant species and their mean diameter:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fia_data_2012</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># clean plots without tree data</span></span>
<span>  <span class="fu"><a href="../reference/clean_empty.html">clean_empty</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># convert inventory table to sf/spatial object</span></span>
<span>  <span class="fu"><a href="../reference/inventory_as_sf.html">inventory_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># unnest the tree data</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># calculate dbh by species in each plot</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id_unique_code</span>, <span class="va">sp_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    dbh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dbh</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    state_ab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">state_ab</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.nan</a></span><span class="op">(</span><span class="va">dbh</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter species with 100 or less entries (plots)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sp_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># let's plot</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">west_coast_map</span>, alpha <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span>, color <span class="op">=</span> <span class="va">dbh</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_gradientn</span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">360</span>, <span class="st">"PinkYl"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">sp_name</span>, ncol <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="ifn-workflow">IFN workflow<a class="anchor" aria-label="anchor" href="#ifn-workflow"></a>
</h2>
<p>For the Spanish forest inventory (IFN) we will explore the Cantabric
coast inventory plots. The IFN, differently from other inventories,
doesn’t offer the data by years, but by <em>versions</em>. We have
<em>“ifn2”</em> (early 90s), <em>“ifn3” (early 00s)</em> and
<em>“ifn4”</em> (2014-15).<br>
We are going o retrive the plots for the latest version
(<em>“ifn4”</em>):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose the provinces, those in the Cantabric area</span></span>
<span><span class="va">north_spain_provinces</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"24"</span>, <span class="st">"33"</span>, <span class="st">"15"</span>, <span class="st">"27"</span>, <span class="st">"39"</span>, <span class="st">"48"</span>, <span class="st">"20"</span><span class="op">)</span></span>
<span><span class="co"># get the plots for those departments</span></span>
<span><span class="va">north_spain_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/show_plots_from.html">show_plots_from</a></span><span class="op">(</span></span>
<span>  <span class="st">"IFN"</span>,</span>
<span>  folder <span class="op">=</span> <span class="va">ifn_folder</span>,</span>
<span>  provinces <span class="op">=</span> <span class="va">north_spain_provinces</span>, versions <span class="op">=</span> <span class="st">"ifn4"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">north_spain_plots</span></span></code></pre></div>
<p>Also, we obtain the provinces polygins with
<code>rnaturalearth</code>, to visualize the plots:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># spain map for plotting</span></span>
<span><span class="va">north_spain_map</span> <span class="op">&lt;-</span> <span class="fu">ne_states</span><span class="op">(</span>country <span class="op">=</span> <span class="st">"spain"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>dep_code <span class="op">=</span> <span class="st">"iso_3166_2"</span>, dep_name <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dep_code <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">dep_code</span>, <span class="st">"ES-"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dep_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"León"</span>, <span class="st">"Asturias"</span>, <span class="st">"La Coruña"</span>, <span class="st">"Lugo"</span>, <span class="st">"Cantabria"</span>, <span class="st">"Bizkaia"</span>, <span class="st">"Gipuzkoa"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">north_spain_map</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span></span>
<span>    <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">province_name_original</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">north_spain_plots</span>, alpha <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">9</span>, palette <span class="op">=</span> <span class="st">"Zissou 1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now that we have the inventory plots selected, we can obtain the
<em>filter list</em> to retrieve the data only from those plots:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ifn_filter_list</span> <span class="op">&lt;-</span> <span class="va">north_spain_plots</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_filter_list.html">create_filter_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we can do all in one pipe:</span></span>
<span><span class="co"># ifn_filter_list &lt;- show_plots_from(</span></span>
<span><span class="co">#    "IFN", folder = ifn_folder, provinces = north_spain_provinces, versions = "ifn4"</span></span>
<span><span class="co"># ) |&gt;</span></span>
<span><span class="co">#   create_filter_list()</span></span></code></pre></div>
<p>And now we have everything we need for retrieving the data with
<code><a href="../reference/ifn_to_tibble.html">ifn_to_tibble()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## We can parallelize the process with the future package.</span></span>
<span><span class="co">## In this case we use 4 parallel processes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the data</span></span>
<span><span class="va">ifn_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ifn_to_tibble.html">ifn_to_tibble</a></span><span class="op">(</span></span>
<span>  provinces <span class="op">=</span> <span class="va">north_spain_provinces</span>,</span>
<span>  versions <span class="op">=</span> <span class="st">"ifn4"</span>,</span>
<span>  filter_list <span class="op">=</span> <span class="va">ifn_filter_list</span>,</span>
<span>  folder <span class="op">=</span> <span class="va">ifn_folder</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As we did with the French and USA inventories, we can now explore the
data, for example, the most abundant species and their mean
diameter:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ifn_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># clean plots without tree data</span></span>
<span>  <span class="fu"><a href="../reference/clean_empty.html">clean_empty</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># convert inventory table to sf/spatial object</span></span>
<span>  <span class="fu"><a href="../reference/inventory_as_sf.html">inventory_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># unnest the tree data</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># calculate dbh by species in each plot</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id_unique_code</span>, <span class="va">sp_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    dbh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dbh</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    province_name_original <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">province_name_original</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.nan</a></span><span class="op">(</span><span class="va">dbh</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter species with 100 or less entries (plots)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sp_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># let's plot</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">north_spain_map</span>, alpha <span class="op">=</span> <span class="fl">0</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geometry</span>, color <span class="op">=</span> <span class="va">dbh</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_gradientn</span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">360</span>, <span class="st">"PinkYl"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">sp_name</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adriana Tovar, Víctor Granda.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
